<template>
  <div>
    <div class="separate-bottom horizontal-left-content">
      <switch-components
        class="full_width"
        v-model="view"
        :options="options"/>
      <default-pin
        v-if="pinSection"
        :section="pinSection"
        @getId="getObject"
        :type="pinType"/>
    </div>
    <slot />
    <template v-if="!addTabs.includes(view)">
      <div
        class="margin-medium-bottom">
        <autocomplete
          v-if="autocomplete"
          :id="`smart-selector-${model}-autocomplete`"
          :input-id="inputId"
          class="separate-right"
          placeholder="Search..."
          :url="autocompleteUrl ? autocompleteUrl : `/${model}/autocomplete`"
          param="term"
          :add-params="autocompleteParams"
          label="label_html"
          :clear-after="clear"
          display="label"
          @getItem="getObject($event.id)"/>
        <otu-picker
          v-if="otuPicker"
          :input-id="inputId"
          :clear-after="true"
          @getItem="getObject($event.id)"/>
      </div>
      <ul
        v-if="view && view != 'search'"
        class="no_bullets"
        :class="{ inline: inline }">
        <li
          v-for="item in lists[view]"
          :key="item.id">
          <template
            v-if="buttons">
            <button
              type="button"
              class="button normal-input tag_button button-data"
              v-html="item[label]"
              @click.prevent="sendObject(item)"/>
          </template>
          <template
            v-else>
            <label @click.prevent="sendObject(item)">
              <input
                v-model="selectedItem"
                :value="item"
                type="radio">
              <span v-html="item[label]"/>
            </label>
          </template>
        </li>
      </ul>
    </template>
    <slot :name="view" />
  </div>
</template>

<script>

import SwitchComponents from 'components/switch'
import AjaxCall from 'helpers/ajaxCall'
import Autocomplete from 'components/autocomplete'
import OrderSmart from 'helpers/smartSelector/orderSmartSelector'
import SelectFirst from 'helpers/smartSelector/selectFirstSmartOption'
import DefaultPin from 'components/getDefaultPin'
import OtuPicker from 'components/otu/otu_picker/otu_picker'
import { getUnique } from 'helpers/arrays.js'

export default {
  components: {
    SwitchComponents,
    Autocomplete,
    DefaultPin,
    OtuPicker
  },
  props: {
    value: {
      type: Object,
      default: undefined
    },
    label: {
      type: String,
      default: 'object_tag'
    },
    inline: {
      type: Boolean,
      default: false
    },
    buttons: {
      type: Boolean,
      default: false
    },
    otuPicker: {
      type: Boolean,
      default: false
    },
    autocompleteParams: {
      type: Object,
      default: undefined
    },
    autocomplete: {
      type: Boolean,
      default: true
    },
    autocompleteUrl: {
      type: String,
      default: undefined
    },
    inputId: {
      type: String,
      default: undefined
    },
    getUrl: {
      type: String,
      default: undefined
    },
    model: {
      type: String,
      default: undefined
    },
    klass: {
      type: String,
      default: undefined
    },
    target: {
      type: String,
      default: undefined
    },
    search: {
      type: Boolean,
      default: true
    },
    selected: {
      type: [Array, String],
      default: undefined
    },
    clear: {
      type: Boolean,
      default: true
    },
    pinSection: {
      type: String,
      default: undefined
    },
    pinType: {
      type: String,
      default: undefined
    },
    addTabs: {
      type: Array,
      default: () => { return [] }
    },
    params: {
      type: Object,
      default: () => { return {} }
    },
    customList: {
      type: Object,
      default: () => { return {} }
    }
  },
  computed: {
    selectedItem: {
      get () {
        return this.value
      },
      set (value) {
        this.$emit('input', value)
      }
    }
  },
  data () {
    return {
      lists: {},
      view: undefined,
      options: [],
      firstTime: true
    }
  },
  watch: {
    view (newVal) {
      this.$emit('onTabSelected', newVal)
    },
    customList: {
      handler () {
        this.addCustomElements()
      },
      deep: true
    }
  },
  mounted () {
    this.refresh()
  },
  methods: {
    getObject (id) {
      AjaxCall('get', this.getUrl ? `${this.getUrl}${id}.json` : `/${this.model}/${id}.json`).then(response => {
        this.sendObject(response.body)
      })
    },
    sendObject (item) {
      this.lastSelected = item
      this.selectedItem = item
      this.$emit('selected', item)
    },
    refresh (forceUpdate = false) {
      if (this.alreadyOnLists() && !forceUpdate) return
      AjaxCall('get', `/${this.model}/select_options`, { params: Object.assign({}, { klass: this.klass, target: this.target }, this.params) }).then(response => {
        this.options = OrderSmart(Object.keys(response.body))
        this.lists = response.body

        if (this.firstTime) {
          this.view = SelectFirst(this.lists, this.options)
          this.firstTime = false
        }

        if (this.search) {
          this.options.push('search')
          if (!this.view) {
            this.view = 'search'
          }
        }
        this.options = this.options.concat(this.addTabs)
      })
    },
    addCustomElements () {
      const keys = Object.keys(this.customList)
      if (keys.length) {
        keys.forEach(key => {
          if (this.lists[key]) {
            this.lists[keys] = getUnique(this.lists[keys].concat(this.customList[key]), 'id')
          }
        })
      }
      this.view = SelectFirst(this.lists, this.options)
    },
    alreadyOnLists () {
      return this.lastSelected ? [].concat(...Object.values(this.lists)).find(item => item.id === this.lastSelected.id) : false
    }
  }
}
</script>
