<%= tag.h2 @klass.table_name.humanize -%>
<p><em> Plots axes are number of records by <%= @target.humanize.downcase %></em> between <%= (@start_date.to_s + ' and ' + @end_date.to_s) %>. Click a name to toggle visibility. </p>
<div>
  <%=column_chart @data, height: '400px' %>
</div>

<h2> Data summary </h2>

<p>Total records over timespan: <%= @data.collect{|d| d[:data].values}.flatten.sum %>.</p>

<table class="tablesorter">
  <tr>
    <th class="header"> Name </th>
    <th class="header"> Total over timespan </th>
    <th class="header"> Sample records (max 5)</th>
  </tr>
  <tbody>
    <% @data.each do |d| %>
      <tr>
        <td> <%= d[:name] %> </td>
        <td> <%= d[:data].values.sum %> </td>
        <td> <%= @klass.where(project_id: sessions_current_project_id, "#{@target}_by_id": d[:id]).where("#{@klass.table_name}.#{@target}_at BETWEEN ? AND ?", @start_date, @end_date).limit(5).collect{|o| object_link(o) }.join('<br>').html_safe %> </td>
      </tr>
      <tr></tr>
    <% end %>
  </tbody>
</table>

<h2> Data table </h2>
<% columns = @data.inject([]){|a, h| a += h[:data].keys; a}.uniq.sort %>
<table>
  <tr>
    <th> Name </th>
    <%= columns.collect{|c| tag.th(c)}.join.html_safe %>
  </tr>
  <tbody>
    <% @data.each do |d| %>
      <tr>
        <td> <%= d[:name] %> </td>
        <%= columns.collect{|c| tag.td( d[:data][c] ) }.join.html_safe %>
       </tr>
    <% end %>
  </tbody>
</table>
